# 8장 '정확히 한 번' 의미 구조

# 개요
7장에서는 카프카 신뢰성 보장에 관한 내용 및 모범사례들을 논의 하였다 <br>
대부분 어플리케이션들은 메시지를 읽는 애플리케이션이 중복 메시지를 제거할 수 있도록 메시지에 고유한 식별자를 포함시킨다 <br>

이벤트를 집적하는 스트림 처리 어플리케이션들은 갈수록 복잡해지고 있다 <br>
이 장에서는 카프카의 '정확히 한 번' 의미 구조를 사용하는 방법과 권장되는 활용 사례, 그리고 그 한계에 대해서 알아볼 것이다 <br>

카프카의 정확히 한 번 의미 구조는 두 개의 핵심기능(멱등적 프로듀서) 와 트랜잭션의 조합으로 이루어 진다 <br>
멱등적 프로듀서는 프로듀서 재시도로 인해 발생하는 중복을 방지한다 <br>

그리고 트랜잭션 의미 구조는 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장한다

# 본론
## 멱등적 프로듀서
동일한 작업을 여러 번 실행해도 한 번 실행한 것과 결과가 같은 서비스를 '멱등적' 이라고 한다 <br>

### 멱등적 프로듀서의 작동원리
멱등적 프로듀서 기능을 켜면, 모든 메시지는 고유한 ProducerID 와 시퀀스 넘버를 가지게 된다 <br>

브로커가 예전에 받은적이 있는 메시지를 받게 될 경우, 적절한 에러를 발생시킨다 <br>

카프카의 멱등적 프로듀서는 프로듀서의 내부 로직으로 인한 재시도가 발생할 경우 생기는 중복만 방지한다 <br>
동일한 메시지를 가지고 2번 호출하면 동작하지 않는다는 뜻 <br>

멱등적 프로듀서 사용법은 간단하다, 프로듀서 설정에 enable.idempotence=true 를 추가해주면 끝이다 <br>
-> 카프카3.0 부터는 기본적으로 켜져있다 <br>



## 트랜잭션
트랜잭션 기능은 카프카 스트림즈를 사용해서 개발된 어플리케이션에 정확성을 보장하기 위해 도입되었다 <br>
각 입력 레코드는 정확히 한 번만 처리되어야 하며, 그 처리 결과 역시 정확히 한 번만 반영되어야 한다 <br>

스트림 처리 애플리케이션의 기본 패턴인 '읽기-처리-쓰기' 패턴에서 사용하도록 개발되었다 <br>
트랜잭션 기능은 이런 맥락에서 '정확히 한 번' 의미 구조를 보장할 수 있다 <br>

#### 트랜잭션이 해결하는 문제
- 어플리케이션 크래시로 인한 재처리
- 좀비 어플리케이션에 의해 발생하는 재처리
  - 스스로가 죽은 상태인지 모르는 컨슈머를 좀비라고 부른다.

트랜잭션을 사용해서 원자적 다수 파티션 쓰기를 수행하려면, 트랜잭션적 프로듀서를 사용해야 한다 <br>
트랜잭션 프로듀서는 transactinal.id 를 사용하며 initTransactions() 를 사용해야 하며, 그 외에 일반적으로는 producer.id 를 사용한다 <br>

애플리케이션의 좀비 인스턴스가 중복 프로듀서를 생성하는 것을 방지하려면 '좀비 펜싱' 혹은 어플리케이션의 좀비 인스턴스가 출력 스트림에 결과를 쓰는 것을 방지할 필요가 있다 <br>

일반적인 좀비 펜싱 방법인 '에포크' 를 사용하는 방식이 쓰인다 <br>































# 결론






